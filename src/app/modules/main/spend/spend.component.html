<div class="!mb-5 lg:!mb-12 flex justify-between items-center">
	<h1 class="mat-headline-5 !text-3xl lg:!text-4xl !mb-0" *ngIf="currentBudget$ | async as currentBudget; else noBudgetTitle">{{ currentBudget.title | translate }}</h1>
	<ng-template #noBudgetTitle>
		<h1 class="mat-headline-5 !text-3xl lg:!text-4xl !mb-0">{{ 'Spend' | translate }}</h1>	
	</ng-template>

	<mat-form-field appearance="outline" color="accent">
		<mat-label>{{ 'current_budget' | translate }}</mat-label>
		<mat-select (selectionChange)="changeBudget($event.value)" [value]="currentBudgetId$ | async">
			<mat-option *ngFor="let budget of budgets$ | async; trackBy:identify" [value]="budget.id">{{ budget.title }}</mat-option>
		</mat-select>
	</mat-form-field>
</div>

<div class="px-10 pb-10 wrapper">
	<div *ngIf="currentBudget$ | async as currentBudget; else noBudget">
		
		<div class="mb-8 px-8 py-4 flex heading-wrapper items-center justify-normal rounded shadow-lg">
			
			<div class="heading-column py-2 px-4 w-1/4 flex items-center justify-center">
				<mat-icon (click)="changeDateByBtn('prev')" class="arrow-icon cursor-pointer">keyboard_arrow_left</mat-icon>
				<span class="mx-3 !mb-0 text-xl">
					{{ dayOfWeek$ | async }}
				</span>
				<mat-icon (click)="changeDateByBtn('next')" class="arrow-icon cursor-pointer">keyboard_arrow_right</mat-icon>
			</div>

			<form [formGroup]="spendForm" class="heading-column py-2 px-4 w-1/4 flex items-center justify-center">
				
				<mat-form-field appearance="outline" class="w-4/5" color="accent">					
					<input matInput [matDatepicker]="picker" formControlName="currentDate" [min]="minCalendarDate" [max]="maxCalendarDate">
					<mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
					<mat-datepicker #picker></mat-datepicker>
					<mat-error>
						{{ formHelpersService.getError(getFormControl('dateEnd')).key | translate:formHelpersService.getError(getFormControl('dateEnd')) }}
					</mat-error>
				</mat-form-field>
			
			</form>
			
			<div class="heading-column py-2 px-4 w-1/4 flex items-center justify-center">
				<span class="mr-3 text-gray-500">Today’s budget:</span>
				<span class="font-semibold">30 USD</span>
			</div>
		
			<div class="heading-column py-2 px-4 w-1/4 flex items-center justify-center">
				<span class="mr-3 text-gray-500">Today’s left:</span>
				<span class="font-semibold">15 USD</span>
			</div>

			

		</div>
		<form [formGroup]="spendFormGroup">
			<div class="mat-elevation-z8">
				<mat-table 
				#table
				[dataSource]="spendArray.controls"
				formArrayName="spendArray">
		
				<ng-container matColumnDef="items">
					<mat-header-cell *matHeaderCellDef class="!py-7 !px-9 uppercase"> Items </mat-header-cell>
					<mat-cell *matCellDef="let element; let i = index" formGroupName="{{ i }}" class="!py-2 !px-9">
						<mat-form-field class="plain-input w-100" appearance="outline">
							<input matInput formControlName="title" (blur)="onBlurExpenseTitle(i)">
						</mat-form-field>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="category">
					<mat-header-cell *matHeaderCellDef class="!py-7 !px-6 !w-1/6 uppercase"> Category </mat-header-cell>
					<mat-cell *matCellDef="let element; let i = index" formGroupName="{{ i }}" class="!py-2 !px-6">
						<mat-form-field class="w-100" appearance="outline" color="accent">
							<mat-select 
								formControlName="categoryId" 
								placeholder="Daily"
								(selectionChange)="handleCategoryChange(i)">
								<ng-container *ngIf="currentBudget$ | async as currentBudget">
									<mat-option *ngFor="let category of currentBudget.expenses; trackBy:identify" [value]="category.id">{{ category.title }}</mat-option>
								</ng-container>
							</mat-select>
							<input type="hidden" #oldAmountInput [value]="element.category">
						</mat-form-field>
					</mat-cell>
				</ng-container>
		
				<ng-container matColumnDef="amount">
					<mat-header-cell *matHeaderCellDef class="!py-7 !px-6 !w-1/6 uppercase"> Amount </mat-header-cell>
					<mat-cell *matCellDef="let element; let i = index" formGroupName="{{ i }}" class="!py-2 !px-6">
						<mat-form-field class="plain-input w-100" appearance="outline">
							<input matInput formControlName="amount" (blur)="onBlurSpendAmount(i)">
						</mat-form-field>
						<input type="hidden" #oldAmountInput [value]="element.amount">
					</mat-cell>
				</ng-container>
		
				<ng-container matColumnDef="balance">
					<mat-header-cell *matHeaderCellDef class="!py-7 !px-6 !w-1/6 uppercase"> Balance </mat-header-cell>
					<mat-cell *matCellDef="let element; let i = index" formGroupName="{{ i }}" class="!py-2 !px-6">
						<mat-form-field class="plain-input"  appearance="outline">
							<input matInput formControlName="balance" class="w-100 cursor-default" readonly>
						</mat-form-field>
					</mat-cell>
				</ng-container>
		
				<ng-container matColumnDef="action">
					<mat-header-cell *matHeaderCellDef class="!py-7 !px-6 rounded-tr-md uppercase">Action</mat-header-cell>
					<mat-cell *matCellDef="let element; let i = index" formGroupName="{{ i }}" class="!py-2 !px-6 justify-center">
						<mat-icon class="cursor-pointer" (click)="openConfirmDeleteDialog(element.value)">delete</mat-icon>
					</mat-cell>
				</ng-container>
		
				
				<mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
				<mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
			</mat-table>
	
			<div class="flex justify-end custom-row">
				<div class="add-row py-2 px-6 flex justify-center items-center">
					<mat-icon class="cursor-pointer ml-6" (click)="addNewSpend()">add</mat-icon>
				</div>
			</div>
	
			<div class="table-footer-top h-16 flex items-center font-semibold uppercase text-lg">
				<div class="px-9">Total:</div>
				<div class="px-6"></div>
				<div class="px-6">{{ currentBudget.total }} {{ currentBudget.currency }}</div>
				<div class="px-6"></div>
				<div class="px-6"></div>
			</div>
	
			<div class="table-footer-bottom rounded-br-md rounded-bl-md h-24 flex items-center font-semibold uppercase text-2xl">
				<div class="px-9">Daily spend:</div>
				<div class="px-6"></div>
				<div class="px-6">{{ currentBudget.daily }} {{ currentBudget.currency }}</div>
				<div class="px-6"></div>
				<div class="px-6"></div>
			</div>
		</div>
	</form>
	</div>

	<ng-template #noBudget>No budget selected. Select or create new budget</ng-template>

</div>

<mat-menu #menu="matMenu" class="custom-mat-menu">
	<button mat-menu-item>
    <mat-icon>check_circle</mat-icon>
    <span>Revise</span>
  </button>
  <button mat-menu-item>
    <mat-icon>delete</mat-icon>
    <span>Archive</span>
  </button>
</mat-menu>

<ng-template #noCategory>
	<mat-form-field class="plain-input"  appearance="outline">
		<input matInput [value]="'-'" class="w-100 cursor-default" readonly>	
	</mat-form-field>
</ng-template>